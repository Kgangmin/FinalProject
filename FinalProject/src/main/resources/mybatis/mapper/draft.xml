<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->

<mapper namespace="com.spring.app.draft.model.DraftDAO">
	
	<select id="getdraftList" parameterType="HashMap" resultType="com.spring.app.draft.domain.DraftDTO"> 
		
		select draft_no ,fk_draft_emp_no, draft_type , draft_title , draft_date ,  approval_status , is_attached
		from tbl_draft
		where fk_draft_emp_no = #{emp_no}
		<if test='!approval_status.equals("")'>
			AND APPROVAL_STATUS = #{approval_status}
		</if>
		<if test='!searchWord.equals("")'>
			AND LOWER(DRAFT_TITLE) LIKE '%' || LOWER(#{searchWord}) || '%' 
		</if>
		<if test='!draft_type.equals("")'>
			AND draft_type LIKE '%' || #{draft_type} || '%' 
		</if>
		
		ORDER BY DRAFT_DATE DESC
		OFFSET #{offset} ROW FETCH NEXT 7 ROWS ONLY
		
	</select>

	<select id="getdraftcount" parameterType="HashMap" resultType="Integer">
		
		select count(*)
		from tbl_draft
		where fk_draft_emp_no = #{emp_no}
		<if test='!approval_status.equals("")'>
			AND APPROVAL_STATUS = #{approval_status}
		</if>
		
		<if test='!searchWord.equals("")'>
			AND LOWER(DRAFT_TITLE) LIKE '%' || LOWER(#{searchWord}) || '%' 
		</if> 
		<if test='!draft_type.equals("")'>
			AND draft_type LIKE '%' || #{draft_type} || '%' 
		</if>
	</select> 
	
	<resultMap type="HashMap" id="draftdetail">
	 	<result property="draft_no" 		column="draft_no"  			javaType="String" />
        <result property="draft_type" 		column="draft_type"  		javaType="String" />
        <result property="draft_title" 		column="draft_title"  		javaType="String" />
		<result property="draft_date" 		column="draft_date"  		javaType="String" />
        <result property="approval_status" 	column="approval_status"  	javaType="String" />
        <result property="is_attached" 		column="is_attached"  		javaType="String" />
		<result property="emp_name" 		column="emp_name"  			javaType="String" />
        <result property="dept_name" 		column="dept_name"  		javaType="String" />
        <result property="phone_num" 		column="phone_num"  		javaType="String" />
	
	</resultMap>
	
	<select id="getdraftdetail" parameterType="String" resultMap="draftdetail">
		
		SELECT d.draft_no, d.draft_type, d.draft_title, d.draft_date, d.approval_status, d.is_attached , e.emp_name , de.dept_name ,e.phone_num
		FROM tbl_draft d join tbl_employee e on d.fk_draft_emp_no = e.emp_no join tbl_department de on e.fk_dept_no = de.dept_no
		WHERE draft_no = #{draft_no}
	
	</select>
	
	<select id="getexpenseList" parameterType="String" resultType="com.spring.app.draft.domain.ExpenseDTO">
	
		select *
		from tbl_expense_request
		where fk_draft_no = #{draft_no}
	</select>
	
	<resultMap type="HashMap" id="approval_line">
	 	<result property="approval_line_no" 		column="approval_line_no"  			javaType="String" />
        <result property="fk_draft_no" 				column="fk_draft_no"  				javaType="String" />
        <result property="fk_approval_emp_no" 		column="fk_approval_emp_no"  		javaType="String" />
		<result property="approval_order" 			column="approval_order"  			javaType="int" />
        <result property="approval_status" 			column="approval_status"  			javaType="String" />
        <result property="emp_name" 				column="emp_name"  					javaType="String" />
        <result property="approval_comment" 		column="approval_comment"  			javaType="String" />
	</resultMap>
	
	<select id="getapprovalLine" parameterType="String" resultMap="approval_line">
		select a.* , e.emp_name , ap.approval_comment
		from tbl_approval_line a join tbl_employee e on e.emp_no = a.fk_approval_emp_no left join tbl_approval ap on a.approval_line_no = ap.fk_approval_line_no
		where fk_draft_no = #{draft_no}
	</select>

	<resultMap type="HashMap" id="fileList">
	 	<result property="fk_draft_no" 				column="fk_draft_no"  			javaType="String" />
        <result property="draft_origin_filename" 	column="draft_origin_filename"  			javaType="String" />
        <result property="draft_save_filename" 		column="draft_save_filename"  javaType="String" />
		<result property="draft_filesize" 			column="draft_filesize"  		javaType="int" />
		<result property="draft_file_no" 			column="draft_file_no"  		javaType="String" />
	</resultMap>
	
	<select id="getfileList" parameterType="String" resultMap="fileList">
		
		select *
		from tbl_draft_file
		where fk_draft_no = #{draft_no}
	</select>
	
	<update id="draftupdate" parameterType="com.spring.app.draft.domain.DraftDTO">
		update tbl_draft set draft_title = #{draft_title} where draft_no = #{draft_no}
	</update>
	
	<select id="selectExpense_no" parameterType="String">
		select expense_no from tbl_expense_request where fk_draft_no = #{draft_no}
	</select>
	
	<update id="expenseUpdate" parameterType="com.spring.app.draft.domain.ExpenseDTO">
		update tbl_expense_request set payee_name = #{payee_name},
									   payee_type = #{payee_type},
									   payee_account = #{payee_account},
									   payee_bank = #{payee_bank},
									   expense_type = #{expense_type},
									   expense_amount = #{expense_amount},
									   expense_date = TO_DATE(#{expense_date}, 'YYYY-MM-DD'),
									   expense_desc = #{expense_desc}
		 WHERE expense_no = #{expense_no}
	</update>
	
	<insert id="expenseInsert" parameterType="com.spring.app.draft.domain.ExpenseDTO">
		  INSERT INTO tbl_expense_request(	expense_no, fk_draft_no, payee_name, payee_type, payee_account, payee_bank,
										    expense_type, expense_amount, expense_date, expense_desc
										  ) VALUES (
										    seq_tbl_expense_request.NEXTVAL,           
										    #{fk_draft_no}, #{payee_name}, #{payee_type}, #{payee_account}, #{payee_bank},
										    #{expense_type}, #{expense_amount}, TO_DATE(#{expense_date}, 'YYYY-MM-DD'), #{expense_desc}
										  )	
	</insert>
	
	<delete id="expenseDelete" >
	  DELETE FROM tbl_expense_request
	  WHERE expense_no IN
	  <foreach collection="list" item="id" open="(" separator="," close=")">
	    #{id}
	  </foreach>
	
	</delete>
	
	<insert id="insertfile" parameterType="HashMap">
		insert into tbl_draft_file values (seq_tbl_draft_file.nextval,#{draft_no} , #{origin} , #{saveName} , #{size}) 
	
	</insert>
	
		<resultMap type="HashMap" id="file">
	 	<result property="fk_draft_no" 				column="fk_draft_no"  			javaType="String" />
        <result property="draft_origin_filename" 	column="draft_origin_filename"  			javaType="String" />
        <result property="draft_save_filename" 		column="draft_save_filename"  javaType="String" />
		<result property="draft_filesize" 			column="draft_filesize"  		javaType="int" />
		<result property="draft_file_no" 			column="draft_file_no"  		javaType="String" />
	</resultMap>
	
	<select id="getfileOne" parameterType="String" resultMap="file">
		select * from tbl_draft_file where draft_file_no = #{draft_file_no} 
	
	</select>
	
	<select id="getdel_fileList" resultType="string">
	  	SELECT draft_save_filename
	    FROM tbl_draft_file
	   	WHERE fk_draft_no = #{draft_no}
	    AND draft_file_no IN
		<foreach collection="list" item="id" open="(" separator="," close=")">
		       #{id}
		</foreach>
	</select>
	
	<delete id="file_delete" >
	  	 DELETE FROM tbl_draft_file
	  	 WHERE fk_draft_no = #{draft_no}
	     AND draft_file_no IN
	     <foreach collection="list" item="id" open="(" separator="," close=")">
	       #{id}
	     </foreach>
	</delete>
	
	<update id="updateattch_N" parameterType="String">
		update tbl_draft set is_attached = 'N'
		where draft_no = #{draft_no}
	</update>
	
	<update id="updateattch_Y" parameterType="String">
		update tbl_draft set is_attached = 'Y'
		where draft_no = #{draft_no}
	</update>
	
	<select id="getLeave" parameterType="String" resultType="com.spring.app.draft.domain.LeaveDTO">
		select *
		from tbl_leave_request 
		where fk_draft_no = #{draft_no}
	</select>
	
</mapper>	
