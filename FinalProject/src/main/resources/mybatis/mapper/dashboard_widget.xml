<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.app.dashboard.model.DashboardWidgetDAO">

  <!-- 결과 매핑 -->
  <resultMap id="WidgetLayoutMap" type="com.spring.app.dashboard.domain.WidgetLayoutDTO">
    <id     property="empNo"     column="FK_EMP_NO"/>
    <id     property="widgetId"  column="WIDGET_ID"/>
    <result property="posX"      column="POS_X"/>
    <result property="posY"      column="POS_Y"/>
    <result property="sizeW"     column="SIZE_W"/>
    <result property="sizeH"     column="SIZE_H"/>
    <result property="visibleYn" column="VISIBLE_YN"/>
    <result property="gridCol"   column="GRID_COL"/>
    <result property="gridRow"   column="GRID_ROW"/>
    <result property="gridW"     column="GRID_W"/>
    <result property="gridH"     column="GRID_H"/>
    <result property="updatedAt" column="UPDATED_AT"/>
  </resultMap>

  <!-- 사번별 전체 레이아웃 조회 -->
  <select id="selectByEmpNo" parameterType="string" resultMap="WidgetLayoutMap">
    SELECT
      FK_EMP_NO, WIDGET_ID,
      POS_X, POS_Y, SIZE_W, SIZE_H,
      VISIBLE_YN,
      GRID_COL, GRID_ROW, GRID_W, GRID_H,
      UPDATED_AT
    FROM TBL_WIDGET_LAYOUT
    WHERE FK_EMP_NO = #{empNo}
    ORDER BY WIDGET_ID
  </select>

  <!-- 단건 UPSERT (서비스에서 리스트 루프 처리 시 사용) -->
  <insert id="upsert" parameterType="com.spring.app.dashboard.domain.WidgetLayoutDTO">
    MERGE INTO TBL_WIDGET_LAYOUT t
    USING (
      SELECT
        #{empNo,jdbcType=VARCHAR}     AS FK_EMP_NO,
        #{widgetId,jdbcType=VARCHAR}  AS WIDGET_ID
      FROM dual
    ) s
    ON (t.FK_EMP_NO = s.FK_EMP_NO AND t.WIDGET_ID = s.WIDGET_ID)

    WHEN MATCHED THEN
      <trim prefix="UPDATE SET" suffixOverrides=",">
        <if test="posX != null">      POS_X      = #{posX,jdbcType=NUMERIC},    </if>
        <if test="posY != null">      POS_Y      = #{posY,jdbcType=NUMERIC},    </if>
        <if test="sizeW != null">     SIZE_W     = #{sizeW,jdbcType=NUMERIC},   </if>
        <if test="sizeH != null">     SIZE_H     = #{sizeH,jdbcType=NUMERIC},   </if>
        <if test="visibleYn != null and visibleYn != ''">
                                      VISIBLE_YN = #{visibleYn,jdbcType=CHAR},  </if>
        <if test="gridCol != null">   GRID_COL   = #{gridCol,jdbcType=NUMERIC}, </if>
        <if test="gridRow != null">   GRID_ROW   = #{gridRow,jdbcType=NUMERIC}, </if>
        <if test="gridW != null">     GRID_W     = #{gridW,jdbcType=NUMERIC},   </if>
        <if test="gridH != null">     GRID_H     = #{gridH,jdbcType=NUMERIC},   </if>
        UPDATED_AT = SYSDATE
      </trim>

    WHEN NOT MATCHED THEN
      INSERT (FK_EMP_NO, WIDGET_ID, POS_X, POS_Y, SIZE_W, SIZE_H,
              VISIBLE_YN,
              GRID_COL, GRID_ROW, GRID_W, GRID_H, UPDATED_AT)
      VALUES (#{empNo,jdbcType=VARCHAR}, #{widgetId,jdbcType=VARCHAR},
              #{posX,jdbcType=NUMERIC},  #{posY,jdbcType=NUMERIC},
              #{sizeW,jdbcType=NUMERIC}, #{sizeH,jdbcType=NUMERIC},
              NVL(#{visibleYn,jdbcType=CHAR}, 'Y'),
              NVL(#{gridCol,jdbcType=NUMERIC}, 0),
              NVL(#{gridRow,jdbcType=NUMERIC}, 0),
              NVL(#{gridW,  jdbcType=NUMERIC}, 0),
              NVL(#{gridH,  jdbcType=NUMERIC}, 0),
              SYSDATE)
  </insert>

  <!-- (선택) 일괄 UPSERT: 컨트롤러/서비스가 Map {empNo, widgets} 형태로 넘길 때 -->
  <insert id="upsertBatch" parameterType="map">
    <foreach collection="widgets" item="w" separator=";">
      MERGE INTO TBL_WIDGET_LAYOUT t
      USING (
        SELECT
          #{empNo,jdbcType=VARCHAR}        AS FK_EMP_NO,
          #{w.widgetId,jdbcType=VARCHAR}   AS WIDGET_ID
        FROM dual
      ) s
      ON (t.FK_EMP_NO = s.FK_EMP_NO AND t.WIDGET_ID = s.WIDGET_ID)
      WHEN MATCHED THEN
        UPDATE SET
          POS_X      = NVL(#{w.posX,jdbcType=NUMERIC},   t.POS_X),
          POS_Y      = NVL(#{w.posY,jdbcType=NUMERIC},   t.POS_Y),
          SIZE_W     = NVL(#{w.sizeW,jdbcType=NUMERIC},  t.SIZE_W),
          SIZE_H     = NVL(#{w.sizeH,jdbcType=NUMERIC},  t.SIZE_H),
          VISIBLE_YN = NVL(#{w.visibleYn,jdbcType=CHAR}, t.VISIBLE_YN),
          GRID_COL   = NVL(#{w.gridCol,jdbcType=NUMERIC},t.GRID_COL),
          GRID_ROW   = NVL(#{w.gridRow,jdbcType=NUMERIC},t.GRID_ROW),
          GRID_W     = NVL(#{w.gridW,  jdbcType=NUMERIC},t.GRID_W),
          GRID_H     = NVL(#{w.gridH,  jdbcType=NUMERIC},t.GRID_H),
          UPDATED_AT = SYSDATE
      WHEN NOT MATCHED THEN
        INSERT (FK_EMP_NO, WIDGET_ID, POS_X, POS_Y, SIZE_W, SIZE_H,
                VISIBLE_YN, GRID_COL, GRID_ROW, GRID_W, GRID_H, UPDATED_AT)
        VALUES (#{empNo,jdbcType=VARCHAR}, #{w.widgetId,jdbcType=VARCHAR},
                #{w.posX,jdbcType=NUMERIC},  #{w.posY,jdbcType=NUMERIC},
                #{w.sizeW,jdbcType=NUMERIC}, #{w.sizeH,jdbcType=NUMERIC},
                NVL(#{w.visibleYn,jdbcType=CHAR}, 'Y'),
                NVL(#{w.gridCol,jdbcType=NUMERIC}, 0),
                NVL(#{w.gridRow,jdbcType=NUMERIC}, 0),
                NVL(#{w.gridW,  jdbcType=NUMERIC}, 0),
                NVL(#{w.gridH,  jdbcType=NUMERIC}, 0),
                SYSDATE)
    </foreach>
  </insert>

  <!-- 삭제 -->
  <delete id="deleteByEmpNoAndWidgetId">
    DELETE FROM TBL_WIDGET_LAYOUT
    WHERE FK_EMP_NO = #{empNo}
      AND WIDGET_ID = #{widgetId}
  </delete>

  <!-- (선택) 보이는 항목만 조회 -->
  <select id="selectVisibleByEmpNo" parameterType="string" resultMap="WidgetLayoutMap">
    SELECT
      FK_EMP_NO, WIDGET_ID,
      POS_X, POS_Y, SIZE_W, SIZE_H,
      VISIBLE_YN,
      GRID_COL, GRID_ROW, GRID_W, GRID_H,
      UPDATED_AT
    FROM TBL_WIDGET_LAYOUT
    WHERE FK_EMP_NO = #{empNo}
      AND VISIBLE_YN = 'Y'
    ORDER BY WIDGET_ID
  </select>

</mapper>
