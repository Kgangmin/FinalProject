<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 반드시 인터페이스 FQN과 동일하게 -->
<mapper namespace="com.spring.app.org.model.OrganizationDAO">

  <!-- 재직자가 1명 이상 배정된 활성 부서만 -->
	<select id="selectDepartmentsHavingEmployees"
	        resultType="com.spring.app.org.domain.DeptDTO">
	  SELECT
	      d.dept_no        AS deptNo,
	      d.dept_name      AS deptName,
	      d.parent_dept_no AS parentDeptNo
	  FROM   tbl_department d
	  WHERE  d.dept_active = 'Y'
	    AND EXISTS (
	      SELECT 1
	      FROM   tbl_employee e
	      WHERE  e.fk_dept_no = d.dept_no
	        AND  e.emp_status = '재직'
	    )
	  ORDER BY d.dept_no
	</select>

  <!-- 각 부서의 모든 '재직' 사원 + 직급(rank_name) + 직급레벨(rank_level) + 직책 LISTAGG -->
<select id="selectDepartmentEmployeesWithPositions"
        resultType="com.spring.app.org.domain.EmpNodeDTO">
  SELECT
      e.emp_no         AS empNo,
      e.emp_name       AS empName,
      e.fk_dept_no     AS deptNo,
      r.rank_name      AS rankName,
      r.rank_level     AS rankLevel,   -- ★ 대표자 선출용 직급레벨
      e.emp_status     AS empStatus,
      (
        SELECT LISTAGG(p.position_name, ', ')
               WITHIN GROUP (ORDER BY p.position_no)
        FROM   tbl_employee_position ep
        JOIN   tbl_position p ON p.position_no = ep.fk_position_no
        WHERE  ep.fk_emp_no = e.emp_no
      )                AS positions
  FROM   tbl_employee e
  JOIN   tbl_rank r
         ON r.rank_no = e.fk_rank_no
  JOIN   tbl_department d
         ON d.dept_no = e.fk_dept_no
        AND d.dept_active = 'Y'     -- 활성 부서만
  WHERE  e.emp_status = '재직'      -- 재직자만
    AND  e.fk_dept_no IS NOT NULL
  ORDER BY
         e.fk_dept_no,
         r.rank_level ASC,          -- 직급 상위 먼저
         e.hiredate ASC,
         e.emp_no
</select>


</mapper>
